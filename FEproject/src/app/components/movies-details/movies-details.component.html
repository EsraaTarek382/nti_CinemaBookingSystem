<div class="movie-details-container">
  <!-- Hero Section with Backdrop -->
  <div class="hero-section position-relative overflow-hidden">
    <div class="hero-backdrop" 
         [style.background-image]="'linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.3)), url(' + movie?.posterUrl+ ')'">
    </div>
    <div class="container-fluid py-5">
      <div class="row align-items-center">
        <div class="col-md-4">
          <div class="movie-poster-container text-center">
            <img [src]="movie?.posterUrl" [alt]="movie?.title" class="movie-poster-large img-fluid rounded-4 shadow-lg">
          </div>
        </div>
        <div class="col-md-8 text-white">
          <div class="movie-info ps-md-4">
            <div class="d-flex align-items-center mb-3">
              <h1 class="display-4 fw-bold me-3">{{ movie?.title }}</h1>
            </div>
            
            <div class="movie-meta mb-4">
              <div class="row">
                <div class="col-auto">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-star-fill text-warning me-2"></i>
                    <span class="h5 mb-0">{{ movie?.rating }}</span>
                  </div>
                </div>
                <div class="col-auto">
                  <span class="text-light">{{ formatDuration(movie?.duration) }}</span>
                </div>
                <div class="col-auto">
                  <span class="text-light">{{ (movie?.releaseDate) | date:'yyyy' }}</span>
                </div>
                <div class="col-auto">
                  <span class="text-light">{{ movie?.genre }}</span>
                </div>
              </div>
            </div>

            <div class="movie-genres mb-4">
              <!-- Backend provides genre as single string, not array -->
              <span class="badge bg-light bg-opacity-20 text-white me-2 mb-2">{{ movie?.genre }}</span>
            </div>

            <p class="lead mb-4">{{ movie?.description }}</p>

            <div class="movie-credits mb-4">
              <div class="row">
                <div class="col-md-6">
                  <strong>Director:</strong> {{ movie?.director }}
                </div>
                <div class="col-md-6">
                  <strong>Cast:</strong> {{ movie?.cast.join(', ') }}
                </div>
              </div>
            </div>

            <div class="action-buttons d-flex gap-3">
            
      
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Showtimes Section -->
  <div class="showtimes-section bg-white py-5">
    <div class="container-fluid">
      <div class="row">
        <!-- Main Content - Full Width -->
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">Select Showtime</h3>
            <span class="badge bg-info">96 Total Seats</span>
          </div>

          <!-- Multiple Showtimes Display -->
          @if (showtimes && showtimes.length > 0) {
            <div class="showtimes-grid mb-5">
              <h5 class="fw-semibold mb-3">Available Showtimes</h5>
              <div class="row g-3">
                @for (showtime of showtimes; track showtime._id) {
                  <div class="col-lg-4 col-md-6">
                    <div class="showtime-card" 
                         [class.selected]="selectedShowtime?._id === showtime._id"
                         (click)="selectShowtime(showtime)">
                      <div class="card h-100 border-2" 
                           [class.border-primary]="selectedShowtime?._id === showtime._id">
                        <div class="card-body p-4">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="time-display">
                              <h5 class="fw-bold mb-1">{{ (showtime.startTime) | date: 'shortTime'}}</h5>
                              <small class="text-muted">{{ (showtime.startTime) |date:'MMM d, y' }}</small>
                            </div>
                            <div class="price-display text-end">
                              <h5 class="fw-bold text-primary mb-0">${{ showtime.price }}</h5>
                              <small class="text-muted">per seat</small>
                            </div>
                          </div>
                          
                          <div class="showtime-stats">
                            <div class="row text-center">
                              <div class="col-6">
                                <div class="fw-semibold text-success">{{ getShowtimeAvailableSeats(showtime) }}</div>
                                <small class="text-muted">Available</small>
                              </div>
                              <div class="col-6">
                                <div class="fw-semibold text-danger">{{ getShowtimeBookedSeats(showtime) }}</div>
                                <small class="text-muted">Booked</small>
                              </div>
                            </div>
                          </div>

                          @if (selectedShowtime?._id === showtime._id) {
                            <div class="mt-3 text-center">
                              <button class="btn btn-primary btn-sm rounded-pill px-3" (click)="startSeatSelection(); $event.stopPropagation()">
                                <i class="bi bi-ticket-perforated me-1"></i>
                                Select Seats
                              </button>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="text-center py-5 text-muted">
              <i class="bi bi-clock display-6 mb-3"></i>
              <p class="h5 mb-2">No Showtimes Available</p>
              <small>Please check back later for available showtimes</small>
            </div>
          }

          <!-- Seat Visualization for Selected Showtime -->
          @if (selectedShowtime && showSeatSelection) {
            <div class="seat-selection-container bg-white rounded-4 p-4 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h5 class="fw-bold mb-1">Select Your Seats</h5>
                  <small class="text-muted">{{ (selectedShowtime.startTime) | date: 'shortTime' }} Show</small>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" (click)="showSeatSelection = false">
                    <i class="bi bi-arrow-left me-1"></i>Back
                  </button>
                  @if (selectedSeats.length > 0) {
                    <button class="btn btn-outline-warning btn-sm" (click)="clearSeatSelection()">
                      <i class="bi bi-arrow-clockwise me-1"></i>Clear Selection
                    </button>
                  }
                </div>
              </div>
              
              <!-- Screen -->
              <div class="screen-container text-center mb-4">
                <div class="screen bg-dark text-white py-3 px-5 rounded-pill d-inline-block">
                  <i class="bi bi-tv me-2"></i>SCREEN
                </div>
              </div>

              <!-- Seat Layout -->
              <div class="seat-layout mb-4">
                @for (rowData of seatLayout; track rowData.row) {
                  <div class="seat-row mb-3 d-flex align-items-center justify-content-center">
                    <!-- Row Label -->
                    <div class="row-label me-3 fw-bold text-muted">{{ rowData.row }}</div>

                    <!-- Left offset spacing -->
                    <div [style.width.px]="rowData.offset * 30"></div>

                    <!-- Seats -->
                    <div class="seats-container d-flex gap-2">
                      @for (seatNumber of getSeatNumbers(rowData.seats); track seatNumber) {
                        <button 
                          [class]="getSeatClass(rowData.row, seatNumber)"
                          [disabled]="getSeatStatus(rowData.row + seatNumber) === 'booked' || getSeatStatus(rowData.row + seatNumber) === 'locked'"
                          (click)="toggleSeat(rowData.row, seatNumber)"
                          [attr.title]="'Seat ' + rowData.row + seatNumber">
                          {{ seatNumber }}
                        </button>
                        
                        <!-- Add gap in middle for aisle -->
                        @if (isAislePosition(seatNumber, rowData.seats)) {
                          <div class="aisle-gap"></div>
                        }
                      }
                    </div>

                    <!-- Row Label (right side) -->
                    <div class="row-label ms-3 fw-bold text-muted">{{ rowData.row }}</div>
                  </div>
                }
              </div>

              <!-- Legend -->
              <div class="legend mb-4 pt-3 border-top">
                <div class="row text-center">
                  <div class="col-md-3">
                    <button class="btn btn-outline-primary btn-sm me-2" disabled></button>
                    <small class="text-muted">Available</small>
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-success btn-sm me-2" disabled></button>
                    <small class="text-muted">Selected</small>
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-danger btn-sm me-2" disabled></button>
                    <small class="text-muted">Booked/Locked</small>
                  </div>
                  <div class="col-md-3">
                    <span class="aisle-indicator me-2"></span>
                    <small class="text-muted">Aisle</small>
                  </div>
                </div>
              </div>

              <!-- Selected Seats Summary -->
              @if (selectedSeats.length > 0) {
                <div class="selected-seats-summary bg-light rounded-3 p-3 mb-3">
                  <div class="row align-items-center">
                    <div class="col-md-8">
                      <h6 class="fw-bold mb-2">Selected Seats:</h6>
                      <div class="seat-tags d-flex flex-wrap gap-2">
                        @for (seat of selectedSeats; track seat) {
                          <span class="badge bg-success fs-6 px-2 py-1">{{ seat }}</span>
                        }
                      </div>
                    </div>
                    <div class="col-md-4 text-end">
                      <div class="pricing-summary">
                        <div class="d-flex justify-content-between mb-1">
                          <small>{{ selectedSeats.length }} seat(s) × ${{ selectedShowtime?.price }}</small>
                          <small>${{ totalPrice }}</small>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                          <small>Convenience Fee</small>
                          <small>$2.50</small>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between fw-bold">
                          <span>Total</span>
                          <span class="text-success">${{ totalPrice + 2.50 }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="text-center">
                  <button class="btn btn-primary btn-lg px-5 rounded-pill" (click)="confirmBooking()">
                    <i class="bi bi-credit-card me-2"></i>
                    Confirm Booking - ${{ (totalPrice + 2.50).toFixed(2) }}
                  </button>
                </div>
              } @else {
                <div class="text-center text-muted py-3">
                  <i class="bi bi-arrow-up-circle display-6 mb-2"></i>
                  <p class="mb-0">Click on available seats to select them</p>
                  <small>You can select up to 8 seats</small>
                </div>
              }
            </div>
          } @else if (selectedShowtime) {
            <div class="seat-preview bg-light rounded-4 p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">Seat Layout Preview</h5>
                <small class="text-muted">{{ (selectedShowtime.startTime) | date: 'shortTime' }} Show</small>
              </div>
              
              <!-- Mini Screen -->
              <div class="mini-screen text-center mb-3">
                <div class="bg-dark text-white py-2 px-4 rounded-pill d-inline-block small">
                  <i class="bi bi-tv me-1"></i>SCREEN
                </div>
              </div>

              <!-- Mini Seat Layout -->
              <div class="mini-seat-layout">
                @for (rowData of seatLayout; track rowData.row) {
                  <div class="mini-seat-row mb-2 d-flex align-items-center justify-content-center">
                    <div class="mini-row-label me-2 small fw-bold text-muted">{{ rowData.row }}</div>
                    
                    <div [style.width.px]="rowData.offset * 8"></div>
                    
                    <div class="mini-seats d-flex gap-1">
                      @for (seatNumber of getSeatNumbers(rowData.seats); track seatNumber) {
                        <div class="mini-seat"
                             [class.booked]="getSeatStatus(rowData.row + seatNumber) === 'booked'"
                             [class.locked]="getSeatStatus(rowData.row + seatNumber) === 'locked'"
                             [class.available]="getSeatStatus(rowData.row + seatNumber) === 'available'">
                        </div>
                        
                        @if (isAislePosition(seatNumber, rowData.seats)) {
                          <div class="mini-aisle-gap"></div>
                        }
                      }
                    </div>
                    
                    <div class="mini-row-label ms-2 small fw-bold text-muted">{{ rowData.row }}</div>
                  </div>
                }
              </div>

              <!-- Mini Legend -->
              <div class="mini-legend mt-3 pt-3 border-top">
                <div class="row text-center">
                  <div class="col-4">
                    <div class="mini-seat available d-inline-block me-1"></div>
                    <small class="text-muted">Available</small>
                  </div>
                  <div class="col-4">
                    <div class="mini-seat booked d-inline-block me-1"></div>
                    <small class="text-muted">Booked</small>
                  </div>
                  <div class="col-4">
                    <small class="text-muted">Click below to select seats</small>
                  </div>
                </div>
              </div>
              
              <div class="text-center mt-3">
                <button class="btn btn-primary btn-lg rounded-pill px-4" (click)="startSeatSelection()">
                  <i class="bi bi-ticket-perforated me-2"></i>
                  Select Seats
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
